<!DOCTYPE html>
<html>
<head>
    <title>–¢–µ—Å—Ç –∫–∞—Ä—Ç—ã</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 20px; }
        #map { height: 500px; border: 3px solid blue; }
    </style>
</head>
<body>
    <h1>–¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É Leaflet</h1>
    <div id="map"></div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
     Golante, [01.02.2026 18:42]
// ============================================
// ‚ö†Ô∏è –í–ê–®–ò –ö–õ–Æ–ß–ò SUPABASE:
// ============================================
const SUPABASE_URL = 'https://mykbslwnmmdkcsyfconh.supabase.co';
const SUPABASE_KEY = `sb_publishable_OJGkhLr8_qmBfn-tqbraQQ_42frnsgH
// ============================================

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let map = null;
let marker = null;
let watchId = null;
let myShareId = null;
let isTracking = false;

// 1. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–†–¢–´ –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
window.addEventListener('DOMContentLoaded', function() {
    console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç—É...');
    initMap();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ —ç—Ç–æ —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    const urlParams = new URLSearchParams(window.location.search);
    const viewId = urlParams.get('view');
    if (viewId) {
        // –†–µ–∂–∏–º –¥–ª—è –¥—Ä—É–≥–∞
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'none';
        document.querySelector('h1').textContent = 'üìç –ü—Ä–æ—Å–º–æ—Ç—Ä –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è';
        loadFriendLocation(viewId);
    }
});

// 2. –°–û–ó–î–ê–ï–ú –ö–ê–†–¢–£
function initMap() {
    try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞—Ä—Ç—ã
        const mapContainer = document.getElementById('map');
        if (!mapContainer) {
            console.error('–û—à–∏–±–∫–∞: –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä #map –Ω–µ –Ω–∞–π–¥–µ–Ω!');
            return;
        }
        
        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É
        map = L.map('map').setView([55.75, 37.61], 13);
        console.log('–ö–∞—Ä—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞');
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–π —Å –∫–∞—Ä—Ç–æ–π
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap',
            maxZoom: 19
        }).addTo(map);
        
        console.log('–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
        updateStatus('‚úÖ –ö–∞—Ä—Ç–∞ –≥–æ—Ç–æ–≤–∞', 'success');
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç—ã:', error);
        updateStatus('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã', 'error');
    }
}

// 3. –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê
function updateStatus(message, type = 'info') {
    const statusEl = document.getElementById('status');
    if (!statusEl) {
        console.log('–°—Ç–∞—Ç—É—Å:', message);
        return;
    }
    
    statusEl.textContent = message;
    statusEl.className = 'status';
    
    if (type === 'success') {
        statusEl.classList.add('status-success');
    } else if (type === 'error') {
        statusEl.classList.add('status-error');
    } else {
        statusEl.classList.add('status-info');
    }
    
    statusEl.style.display = 'block';
}

// 4. –ù–ê–ß–ê–¢–¨ –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–ï
async function startTracking() {
    if (isTracking) return;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—Ä—Ç—É
    if (!map) {
        updateStatus('‚ùå –ö–∞—Ä—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å', 'error');
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
    if (!navigator.geolocation) {
        updateStatus('‚ùå –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é', 'error');
        return;
    }
    
    // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫–∏
    document.getElementById('startBtn').disabled = true;
    document.getElementById('stopBtn').disabled = false;
    isTracking = true;
    
    // –°–æ–∑–¥–∞–µ–º ID
    myShareId = 'user_' + Date.now();
    
    updateStatus('üìç –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...', 'info');
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
    watchId = navigator.geolocation.watchPosition(
        // –£—Å–ø–µ—Ö
        async (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞ –∫–∞—Ä—Ç–µ
            updateMapPosition(lat, lng);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É
            await saveLocation(lat, lng);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É
            showShareLink();
        },
        
        // –û—à–∏–±–∫–∞
        (error) => {
            let msg = '–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏';
            if (error.code === 1) msg = '–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏';
            if (error.code === 2) msg = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ';
            if (error.code === 3) msg = '–¢–∞–π–º–∞—É—Ç';
            
            updateStatus('‚ùå ' + msg, 'error');
            stopTracking();
        },

Golante, [01.02.2026 18:42]
// –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}

// 5. –û–ë–ù–û–í–ò–¢–¨ –ü–û–ó–ò–¶–ò–Æ –ù–ê –ö–ê–†–¢–ï
function updateMapPosition(lat, lng) {
    if (!map) return;
    
    if (!marker) {
        // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä
        marker = L.marker([lat, lng]).addTo(map);
        map.setView([lat, lng], 16);
        marker.bindPopup('–í—ã –∑–¥–µ—Å—å').openPopup();
    } else {
        // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä
        marker.setLatLng([lat, lng]);
    }
}

// 6. –°–û–•–†–ê–ù–ò–¢–¨ –í –ë–ê–ó–£
async function saveLocation(lat, lng) {
    try {
        const { error } = await supabase
            .from('locations')
            .upsert({
                share_id: myShareId,
                latitude: lat,
                longitude: lng,
                updated_at: new Date().toISOString()
            });
        
        if (error) {
            console.error('–û—à–∏–±–∫–∞ Supabase:', error);
            updateStatus('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
            return false;
        }
        
        const time = new Date().toLocaleTimeString();
        updateStatus(`‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${time}`, 'success');
        return true;
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        return false;
    }
}

// 7. –ü–û–ö–ê–ó–ê–¢–¨ –°–°–´–õ–ö–£
function showShareLink() {
    const shareSection = document.getElementById('shareSection');
    if (!shareSection) return;
    
    if (shareSection.style.display !== 'block') {
        shareSection.style.display = 'block';
        
        // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É
        const baseUrl = window.location.origin + window.location.pathname;
        const shareUrl = baseUrl + '?view=' + myShareId;
        
        document.getElementById('share-link').value = shareUrl;
        updateStatus('‚úÖ –°—Å—ã–ª–∫–∞ –≥–æ—Ç–æ–≤–∞! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –¥—Ä—É–≥—É.', 'success');
    }
}

// 8. –û–°–¢–ê–ù–û–í–ò–¢–¨ –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–ï
function stopTracking() {
    if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
    }
    
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
    isTracking = false;
    
    updateStatus('‚èπÔ∏è –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'error');
}

// 9. –ö–û–ü–ò–†–û–í–ê–¢–¨ –°–°–´–õ–ö–£
function copyShareLink() {
    const linkInput = document.getElementById('share-link');
    if (!linkInput || !linkInput.value) return;
    
    linkInput.select();
    navigator.clipboard.writeText(linkInput.value)
        .then(() => updateStatus('‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!', 'success'))
        .catch(() => updateStatus('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å', 'error'));
}

// 10. –ü–û–î–ï–õ–ò–¢–¨–°–Ø –í WHATSAPP
function shareWhatsApp() {
    const link = document.getElementById('share-link').value;
    const text = üìç –ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:\n${link};
    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
}

// 11. –ü–û–î–ï–õ–ò–¢–¨–°–Ø –í TELEGRAM
function shareTelegram() {
    const link = document.getElementById('share-link').value;
    window.open(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=üìç –ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ`, '_blank');
}

// 12. –ó–ê–ì–†–£–ó–ò–¢–¨ –ú–ï–°–¢–û–ü–û–õ–û–ñ–ï–ù–ò–ï –î–†–£–ì–ê
async function loadFriendLocation(shareId) {
    updateStatus('üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...', 'info');
    
    try {
        const { data } = await supabase
            .from('locations')
            .select('*')
            .eq('share_id', shareId)
            .order('updated_at', { ascending: false })
            .limit(1);
        
        if (data && data[0]) {
            const loc = data[0];
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞ –∫–∞—Ä—Ç–µ
            L.marker([loc.latitude, loc.longitude])
                .addTo(map)
                .bindPopup(`–î—Ä—É–≥<br>–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(loc.updated_at).toLocaleTimeString()}`)
                .openPopup();
            
            map.setView([loc.latitude, loc.longitude], 15);
            updateStatus('‚úÖ –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'success');
            
            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            setInterval(() => loadFriendLocation(shareId), 5000);
        } else {

Golante, [01.02.2026 18:42]
updateStatus('‚ùå –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
        }
    } catch (error) {
        updateStatus('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
    }
}
    </script>
</body>
</html>
